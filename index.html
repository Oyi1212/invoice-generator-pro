<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Rechnungsprogramm 3.0</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide-react/0.263.1/lucide-react.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        import React, { useState, useEffect, useRef } from 'react';
        import { Plus, Edit, Trash2, Search, Filter, Download, FileText, Users, Package, Settings, Eye, Mail, BarChart3, Calendar, Clock, Receipt, CreditCard, TrendingUp, Moon, Sun, Upload, RefreshCw, AlertTriangle, CheckCircle, XCircle, DollarSign, Euro, Copy, Send, Printer, FileImage, Briefcase, Target, PieChart, Activity, Globe } from 'lucide-react';
        
        const EnterpriseInvoiceApp = () => {
          // Enhanced State Management
          const [activeTab, setActiveTab] = useState('dashboard');
          const [darkMode, setDarkMode] = useState(false);
          const [currentLanguage, setCurrentLanguage] = useState('de');
          
          // Core Data
          const [customers, setCustomers] = useState([]);
          const [products, setProducts] = useState([]);
          const [invoices, setInvoices] = useState([]);
          const [quotes, setQuotes] = useState([]);
          const [reminders, setReminders] = useState([]);
          const [projects, setProjects] = useState([]);
          const [expenses, setExpenses] = useState([]);
          const [timeEntries, setTimeEntries] = useState([]);
          const [categories, setCategories] = useState([
            { id: '1', name: 'Webdesign', color: '#3B82F6' },
            { id: '2', name: 'Beratung', color: '#10B981' },
            { id: '3', name: 'Entwicklung', color: '#F59E0B' }
          ]);
          
          // Company Data with multiple profiles
          const [companyProfiles, setCompanyProfiles] = useState([]);
          const [activeProfile, setActiveProfile] = useState('');
          const [companyData, setCompanyData] = useState({
            id: '',
            name: '',
            address: '',
            city: '',
            postalCode: '',
            phone: '',
            email: '',
            website: '',
            taxId: '',
            vatId: '',
            bankName: '',
            iban: '',
            bic: '',
            logo: '',
            currency: 'EUR',
            taxRate: '19',
            isSmallBusiness: false,
            paymentTerms: '30',
            template: 'modern'
          });
        
          // Settings
          const [settings, setSettings] = useState({
            currency: 'EUR',
            language: 'de',
            taxRate: 19,
            autoBackup: true,
            reminderDays: [7, 14, 30],
            invoicePrefix: 'RE',
            quotePrefix: 'AN',
            theme: 'light'
          });
        
          // Modals
          const [modals, setModals] = useState({
            customer: false,
            product: false,
            invoice: false,
            company: false,
            project: false,
            expense: false,
            timeEntry: false,
            reminder: false,
            settings: false,
            backup: false,
            import: false,
            preview: false
          });
        
          // Forms
          const [editingItem, setEditingItem] = useState(null);
          const [previewData, setPreviewData] = useState(null);
          
          const [customerForm, setCustomerForm] = useState({
            name: '', address: '', city: '', postalCode: '', email: '', vatId: '', 
            phone: '', website: '', contactPerson: '', notes: '', paymentTerms: '30'
          });
          
          const [productForm, setProductForm] = useState({
            name: '', description: '', price: '', taxRate: '19', category: '', unit: 'Stück', sku: ''
          });
          
          const [invoiceForm, setInvoiceForm] = useState({
            type: 'invoice',
            customerId: '',
            projectId: '',
            items: [],
            notes: '',
            dueDate: '',
            discount: 0,
            discountType: 'percent',
            currency: 'EUR',
            recurring: false,
            recurringInterval: 'monthly',
            template: 'modern'
          });
        
          const [projectForm, setProjectForm] = useState({
            name: '', description: '', customerId: '', startDate: '', endDate: '', 
            status: 'active', budget: 0, hourlyRate: 0
          });
        
          const [expenseForm, setExpenseForm] = useState({
            description: '', amount: '', category: 'office', date: '', receipt: '', projectId: ''
          });
        
          // Filters and search
          const [filters, setFilters] = useState({
            search: '',
            status: 'all',
            dateRange: 'all',
            customer: 'all',
            project: 'all'
          });
        
          const fileInputRef = useRef(null);
          const logoInputRef = useRef(null);
        
          // Translations
          const translations = {
            de: {
              dashboard: 'Dashboard',
              customers: 'Kunden',
              products: 'Produkte',
              invoices: 'Rechnungen',
              quotes: 'Angebote',
              projects: 'Projekte',
              expenses: 'Ausgaben',
              reports: 'Berichte',
              settings: 'Einstellungen',
              add: 'Hinzufügen',
              edit: 'Bearbeiten',
              delete: 'Löschen',
              save: 'Speichern',
              cancel: 'Abbrechen',
              total: 'Gesamt',
              subtotal: 'Zwischensumme',
              tax: 'MwSt',
              discount: 'Rabatt',
              dueDate: 'Fälligkeitsdatum'
            },
            en: {
              dashboard: 'Dashboard',
              customers: 'Customers',
              products: 'Products',
              invoices: 'Invoices',
              quotes: 'Quotes',
              projects: 'Projects',
              expenses: 'Expenses',
              reports: 'Reports',
              settings: 'Settings',
              add: 'Add',
              edit: 'Edit',
              delete: 'Delete',
              save: 'Save',
              cancel: 'Cancel',
              total: 'Total',
              subtotal: 'Subtotal',
              tax: 'Tax',
              discount: 'Discount',
              dueDate: 'Due Date'
            }
          };
        
          const t = (key) => translations[currentLanguage][key] || key;
        
          // Load all data from localStorage
          useEffect(() => {
            const loadData = () => {
              try {
                const data = {
                  customers: JSON.parse(localStorage.getItem('customers') || '[]'),
                  products: JSON.parse(localStorage.getItem('products') || '[]'),
                  invoices: JSON.parse(localStorage.getItem('invoices') || '[]'),
                  quotes: JSON.parse(localStorage.getItem('quotes') || '[]'),
                  projects: JSON.parse(localStorage.getItem('projects') || '[]'),
                  expenses: JSON.parse(localStorage.getItem('expenses') || '[]'),
                  timeEntries: JSON.parse(localStorage.getItem('timeEntries') || '[]'),
                  companyProfiles: JSON.parse(localStorage.getItem('companyProfiles') || '[]'),
                  settings: JSON.parse(localStorage.getItem('settings') || '{}'),
                  reminders: JSON.parse(localStorage.getItem('reminders') || '[]'),
                  categories: JSON.parse(localStorage.getItem('categories') || '[]')
                };
        
                setCustomers(data.customers);
                setProducts(data.products);
                setInvoices(data.invoices);
                setQuotes(data.quotes);
                setProjects(data.projects);
                setExpenses(data.expenses);
                setTimeEntries(data.timeEntries);
                setCompanyProfiles(data.companyProfiles);
                setReminders(data.reminders);
                if (data.categories.length > 0) setCategories(data.categories);
                
                setSettings({...settings, ...data.settings});
                setCurrentLanguage(data.settings.language || 'de');
                setDarkMode(data.settings.theme === 'dark');
        
                if (data.companyProfiles.length > 0) {
                  setActiveProfile(data.companyProfiles[0].id);
                  setCompanyData(data.companyProfiles[0]);
                }
              } catch (error) {
                console.error('Error loading data:', error);
              }
            };
        
            loadData();
          }, []);
        
          // Auto-save data
          useEffect(() => { localStorage.setItem('customers', JSON.stringify(customers)); }, [customers]);
          useEffect(() => { localStorage.setItem('products', JSON.stringify(products)); }, [products]);
          useEffect(() => { localStorage.setItem('invoices', JSON.stringify(invoices)); }, [invoices]);
          useEffect(() => { localStorage.setItem('quotes', JSON.stringify(quotes)); }, [quotes]);
          useEffect(() => { localStorage.setItem('projects', JSON.stringify(projects)); }, [projects]);
          useEffect(() => { localStorage.setItem('expenses', JSON.stringify(expenses)); }, [expenses]);
          useEffect(() => { localStorage.setItem('timeEntries', JSON.stringify(timeEntries)); }, [timeEntries]);
          useEffect(() => { localStorage.setItem('companyProfiles', JSON.stringify(companyProfiles)); }, [companyProfiles]);
          useEffect(() => { localStorage.setItem('settings', JSON.stringify(settings)); }, [settings]);
          useEffect(() => { localStorage.setItem('reminders', JSON.stringify(reminders)); }, [reminders]);
          useEffect(() => { localStorage.setItem('categories', JSON.stringify(categories)); }, [categories]);
        
          // Utility functions
          const generateNumber = (type) => {
            const year = new Date().getFullYear();
            const prefix = type === 'invoice' ? settings.invoicePrefix : settings.quotePrefix;
            const items = type === 'invoice' ? invoices : quotes;
            const count = items.filter(item => item.number.startsWith(`${prefix}${year}`)).length + 1;
            return `${prefix}${year}-${count.toString().padStart(4, '0')}`;
          };
        
          const formatCurrency = (amount, currency = settings.currency) => {
            const currencies = {
              EUR: { symbol: '€', locale: 'de-DE' },
              USD: { symbol: '$', locale: 'en-US' },
              GBP: { symbol: '£', locale: 'en-GB' },
              JPY: { symbol: '¥', locale: 'ja-JP' },
              CHF: { symbol: 'CHF', locale: 'de-CH' }
            };
            
            const config = currencies[currency] || currencies.EUR;
            return new Intl.NumberFormat(config.locale, {
              style: 'currency',
              currency: currency
            }).format(amount);
          };
        
          const formatDate = (date) => {
            return new Date(date).toLocaleDateString(currentLanguage === 'de' ? 'de-DE' : 'en-US');
          };
        
          const calculateAge = (date) => {
            const today = new Date();
            const created = new Date(date);
            const diffTime = Math.abs(today - created);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          };
        
          // Enhanced calculations
          const calculateInvoiceTotal = (items, discount = 0, discountType = 'percent') => {
            const subtotal = items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            let discountAmount = 0;
            
            if (discountType === 'percent') {
              discountAmount = subtotal * (discount / 100);
            } else {
              discountAmount = discount;
            }
            
            const discountedSubtotal = subtotal - discountAmount;
            const taxAmount = items.reduce((sum, item) => {
              const itemTotal = (item.quantity * item.price) * (1 - (discountType === 'percent' ? discount / 100 : discount / subtotal));
              return sum + (itemTotal * (item.taxRate / 100));
            }, 0);
            
            return {
              subtotal: subtotal,
              discount: discountAmount,
              taxAmount: taxAmount,
              total: discountedSubtotal + taxAmount
            };
          };
        
          // CRUD Operations with enhanced features
          const saveCustomer = () => {
            if (!customerForm.name.trim()) return;
            
            const customerData = {
              ...customerForm,
              id: editingItem?.id || Date.now().toString(),
              createdAt: editingItem?.createdAt || new Date().toISOString(),
              updatedAt: new Date().toISOString()
            };
            
            if (editingItem) {
              setCustomers(customers.map(c => c.id === editingItem.id ? customerData : c));
            } else {
              setCustomers([...customers, customerData]);
            }
            resetForms('customer');
          };
        
          const saveProduct = () => {
            if (!productForm.name.trim() || !productForm.price) return;
            
            const productData = {
              ...productForm,
              id: editingItem?.id || Date.now().toString(),
              price: parseFloat(productForm.price),
              taxRate: parseFloat(productForm.taxRate),
              createdAt: editingItem?.createdAt || new Date().toISOString(),
              updatedAt: new Date().toISOString()
            };
            
            if (editingItem) {
              setProducts(products.map(p => p.id === editingItem.id ? productData : p));
            } else {
              setProducts([...products, productData]);
            }
            resetForms('product');
          };
        
          const saveInvoice = () => {
            const customer = customers.find(c => c.id === invoiceForm.customerId);
            const project = projects.find(p => p.id === invoiceForm.projectId);
            if (!customer || invoiceForm.items.length === 0) return;
        
            const calculations = calculateInvoiceTotal(invoiceForm.items, invoiceForm.discount, invoiceForm.discountType);
            
            const invoiceData = {
              id: editingItem?.id || Date.now().toString(),
              number: editingItem?.number || generateNumber(invoiceForm.type),
              type: invoiceForm.type,
              customer: customer,
              project: project || null,
              items: invoiceForm.items,
              ...calculations,
              discount: invoiceForm.discount,
              discountType: invoiceForm.discountType,
              date: editingItem?.date || new Date().toISOString().split('T')[0],
              dueDate: invoiceForm.dueDate || new Date(Date.now() + parseInt(customer.paymentTerms || '30') * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
              status: invoiceForm.type === 'quote' ? 'pending' : 'open',
              notes: invoiceForm.notes,
              currency: invoiceForm.currency,
              recurring: invoiceForm.recurring,
              recurringInterval: invoiceForm.recurringInterval,
              template: invoiceForm.template,
              createdAt: editingItem?.createdAt || new Date().toISOString(),
              updatedAt: new Date().toISOString()
            };
        
            if (invoiceForm.type === 'invoice') {
              if (editingItem) {
                setInvoices(invoices.map(i => i.id === editingItem.id ? invoiceData : i));
              } else {
                setInvoices([...invoices, invoiceData]);
              }
            } else {
              if (editingItem) {
                setQuotes(quotes.map(q => q.id === editingItem.id ? invoiceData : q));
              } else {
                setQuotes([...quotes, invoiceData]);
              }
            }
            
            resetForms('invoice');
            
            // Create automatic reminder if needed
            if (invoiceForm.type === 'invoice') {
              createAutomaticReminders(invoiceData);
            }
          };
        
          const saveProject = () => {
            if (!projectForm.name.trim()) return;
            
            const projectData = {
              ...projectForm,
              id: editingItem?.id || Date.now().toString(),
              budget: parseFloat(projectForm.budget || 0),
              hourlyRate: parseFloat(projectForm.hourlyRate || 0),
              createdAt: editingItem?.createdAt || new Date().toISOString(),
              updatedAt: new Date().toISOString()
            };
            
            if (editingItem) {
              setProjects(projects.map(p => p.id === editingItem.id ? projectData : p));
            } else {
              setProjects([...projects, projectData]);
            }
            resetForms('project');
          };
        
          const saveExpense = () => {
            if (!expenseForm.description.trim() || !expenseForm.amount) return;
            
            const expenseData = {
              ...expenseForm,
              id: editingItem?.id || Date.now().toString(),
              amount: parseFloat(expenseForm.amount),
              date: expenseForm.date || new Date().toISOString().split('T')[0],
              createdAt: editingItem?.createdAt || new Date().toISOString(),
              updatedAt: new Date().toISOString()
            };
            
            if (editingItem) {
              setExpenses(expenses.map(e => e.id === editingItem.id ? expenseData : e));
            } else {
              setExpenses([...expenses, expenseData]);
            }
            resetForms('expense');
          };
        
          const createAutomaticReminders = (invoice) => {
            settings.reminderDays.forEach(days => {
              const reminderDate = new Date(invoice.dueDate);
              reminderDate.setDate(reminderDate.getDate() + days);
              
              const reminder = {
                id: `${invoice.id}_${days}`,
                invoiceId: invoice.id,
                type: 'payment_reminder',
                dueDate: reminderDate.toISOString().split('T')[0],
                level: days <= 7 ? 1 : days <= 14 ? 2 : 3,
                status: 'pending',
                createdAt: new Date().toISOString()
              };
              
              setReminders(prev => [...prev.filter(r => r.id !== reminder.id), reminder]);
            });
          };
        
          // Reset functions
          const resetForms = (type) => {
            const modalMap = {
              customer: () => {
                setCustomerForm({ name: '', address: '', city: '', postalCode: '', email: '', vatId: '', phone: '', website: '', contactPerson: '', notes: '', paymentTerms: '30' });
                setModals(prev => ({ ...prev, customer: false }));
              },
              product: () => {
                setProductForm({ name: '', description: '', price: '', taxRate: '19', category: '', unit: 'Stück', sku: '' });
                setModals(prev => ({ ...prev, product: false }));
              },
              invoice: () => {
                setInvoiceForm({ type: 'invoice', customerId: '', projectId: '', items: [], notes: '', dueDate: '', discount: 0, discountType: 'percent', currency: 'EUR', recurring: false, recurringInterval: 'monthly', template: 'modern' });
                setModals(prev => ({ ...prev, invoice: false }));
              },
              project: () => {
                setProjectForm({ name: '', description: '', customerId: '', startDate: '', endDate: '', status: 'active', budget: 0, hourlyRate: 0 });
                setModals(prev => ({ ...prev, project: false }));
              },
              expense: () => {
                setExpenseForm({ description: '', amount: '', category: 'office', date: '', receipt: '', projectId: '' });
                setModals(prev => ({ ...prev, expense: false }));
              }
            };
            
            modalMap[type]?.();
            setEditingItem(null);
          };
        
          // Enhanced delete function
          const deleteItem = (type, id) => {
            if (!window.confirm('Wirklich löschen?')) return;
            
            const deleteMap = {
              customer: () => setCustomers(customers.filter(c => c.id !== id)),
              product: () => setProducts(products.filter(p => p.id !== id)),
              invoice: () => setInvoices(invoices.filter(i => i.id !== id)),
              quote: () => setQuotes(quotes.filter(q => q.id !== id)),
              project: () => setProjects(projects.filter(p => p.id !== id)),
              expense: () => setExpenses(expenses.filter(e => e.id !== id))
            };
            
            deleteMap[type]?.();
          };
        
          // Invoice item management
          const addInvoiceItem = (product) => {
            const item = {
              id: Date.now().toString(),
              productId: product.id,
              name: product.name,
              description: product.description,
              quantity: 1,
              price: parseFloat(product.price),
              taxRate: parseFloat(product.taxRate),
              unit: product.unit || 'Stück'
            };
            setInvoiceForm(prev => ({ ...prev, items: [...prev.items, item] }));
          };
        
          const updateInvoiceItem = (itemId, field, value) => {
            setInvoiceForm(prev => ({
              ...prev,
              items: prev.items.map(item => 
                item.id === itemId 
                  ? { ...item, [field]: ['quantity', 'price', 'taxRate'].includes(field) ? parseFloat(value) || 0 : value }
                  : item
              )
            }));
          };
        
          const removeInvoiceItem = (itemId) => {
            setInvoiceForm(prev => ({
              ...prev,
              items: prev.items.filter(item => item.id !== itemId)
            }));
          };
        
          // Status management
          const updateInvoiceStatus = (id, status) => {
            setInvoices(invoices.map(inv => 
              inv.id === id ? { ...inv, status, paidAt: status === 'paid' ? new Date().toISOString() : null } : inv
            ));
          };
        
          // Export functions
          const exportToCSV = (data, filename, headers) => {
            const csvContent = [
              headers.join(';'),
              ...data.map(row => headers.map(header => 
                typeof row[header.toLowerCase()] === 'number' 
                  ? row[header.toLowerCase()].toFixed(2).replace('.', ',')
                  : (row[header.toLowerCase()] || '').toString().replace(';', ',')
              ).join(';'))
            ].join('\n');
        
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
          };
        
          // Enhanced PDF generation
          const generatePDF = (invoice) => {
            const content = generateInvoiceHTML(invoice);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
              <!DOCTYPE html>
              <html>
              <head>
                <title>${invoice.number}</title>
                <meta charset="utf-8">
                <style>
                  body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
                  .header { display: flex; justify-content: space-between; margin-bottom: 30px; }
                  .logo { max-width: 150px; height: auto; }
                  .company-info { text-align: right; }
                  .invoice-info { background: #f8f9fa; padding: 15px; margin: 20px 0; }
                  .customer-info { margin: 20px 0; }
                  .items-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                  .items-table th, .items-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                  .items-table th { background: #f8f9fa; }
                  .totals { text-align: right; margin-top: 20px; }
                  .total-row { font-weight: bold; font-size: 1.2em; }
                  @media print { body { margin: 0; } }
                </style>
              </head>
              <body>${content}</body>
              </html>
            `);
            
            printWindow.document.close();
            setTimeout(() => {
              printWindow.print();
              printWindow.close();
            }, 250);
          };
        
          const generateInvoiceHTML = (invoice) => {
            const calculations = calculateInvoiceTotal(invoice.items, invoice.discount, invoice.discountType);
            
            return `
              <div class="header">
                <div class="company-info">
                  ${companyData.logo ? `<img src="${companyData.logo}" alt="Logo" class="logo" />` : ''}
                  <h2>${companyData.name}</h2>
                  <p>${companyData.address}<br>
                  ${companyData.postalCode} ${companyData.city}<br>
                  Tel: ${companyData.phone}<br>
                  E-Mail: ${companyData.email}</p>
                </div>
                <div class="invoice-details">
                  <h1>${invoice.type === 'invoice' ? 'Rechnung' : 'Angebot'} ${invoice.number}</h1>
                  <p><strong>Datum:</strong> ${formatDate(invoice.date)}</p>
                  <p><strong>Fällig am:</strong> ${formatDate(invoice.dueDate)}</p>
                </div>
              </div>
              
              <div class="customer-info">
                <h3>Rechnungsempfänger:</h3>
                <p><strong>${invoice.customer.name}</strong><br>
                ${invoice.customer.address}<br>
                ${invoice.customer.postalCode} ${invoice.customer.city}<br>
                ${invoice.customer.vatId ? `USt-ID: ${invoice.customer.vatId}` : ''}</p>
              </div>
              
              <table class="items-table">
                <thead>
                  <tr>
                    <th>Pos.</th>
                    <th>Beschreibung</th>
                    <th>Menge</th>
                    <th>Einzelpreis</th>
                    <th>Gesamtpreis</th>
                  </tr>
                </thead>
                <tbody>
                  ${invoice.items.map((item, index) => `
                    <tr>
                      <td>${index + 1}</td>
                      <td>${item.name}<br><small>${item.description}</small></td>
                      <td>${item.quantity} ${item.unit}</td>
                      <td>${formatCurrency(item.price)}</td>
                      <td>${formatCurrency(item.quantity * item.price)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
              
              <div class="totals">
                <p>Zwischensumme: ${formatCurrency(calculations.subtotal)}</p>
                ${calculations.discount > 0 ? `<p>Rabatt: -${formatCurrency(calculations.discount)}</p>` : ''}
                <p>MwSt (${invoice.items[0]?.taxRate || 19}%): ${formatCurrency(calculations.taxAmount)}</p>
                <p class="total-row">Gesamtbetrag: ${formatCurrency(calculations.total)}</p>
              </div>
              
              <div style="margin-top: 40px;">
                <h3>Zahlungsinformationen:</h3>
                <p><strong>${companyData.bankName}</strong><br>
                IBAN: ${companyData.iban}<br>
                BIC: ${companyData.bic}</p>
                <p>Bitte überweisen Sie den Betrag bis zum Fälligkeitsdatum auf das angegebene Konto.</p>
                ${invoice.notes ? `<div style="margin-top: 20px;"><strong>Anmerkungen:</strong><br>${invoice.notes}</div>` : ''}
              </div>
            `;
          };
        
          // Statistics calculations
          const getStatistics = () => {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();
            
            const yearlyRevenue = invoices
              .filter(inv => inv.status === 'paid' && new Date(inv.date).getFullYear() === currentYear)
              .reduce((sum, inv) => sum + inv.total, 0);
            
            const monthlyRevenue = invoices
              .filter(inv => inv.status === 'paid' && new Date(inv.date).getMonth() === currentMonth)
              .reduce((sum, inv) => sum + inv.total, 0);
            
            const openInvoices = invoices.filter(inv => inv.status === 'open');
            const overdueInvoices = invoices.filter(inv => 
              inv.status === 'open' && new Date(inv.dueDate) < new Date()
            );
            
            const totalOutstanding = openInvoices.reduce((sum, inv) => sum + inv.total, 0);
            const totalOverdue = overdueInvoices.reduce((sum, inv) => sum + inv.total, 0);
            
            return {
              yearlyRevenue,
              monthlyRevenue,
              openInvoices: openInvoices.length,
              overdueInvoices: overdueInvoices.length,
              totalOutstanding,
              totalOverdue,
              totalCustomers: customers.length,
              totalProducts: products.length,
              activeProjects: projects.filter(p => p.status === 'active').length
            };
          };
        
          const stats = getStatistics();
        
          // File handling
          const handleLogoUpload = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                setCompanyData(prev => ({ ...prev, logo: e.target.result }));
              };
              reader.readAsDataURL(file);
            }
          };
        
          const handleBackupExport = () => {
            const backupData = {
              customers,
              products,
              invoices,
              quotes,
              projects,
              expenses,
              timeEntries,
              companyProfiles,
              settings,
              reminders,
              categories,
              version: '3.0',
              exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
          };
        
          const handleBackupImport = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                try {
                  const backupData = JSON.parse(e.target.result);
                  
                  if (window.confirm('Alle aktuellen Daten werden überschrieben. Fortfahren?')) {
                    setCustomers(backupData.customers || []);
                    setProducts(backupData.products || []);
                    setInvoices(backupData.invoices || []);
                    setQuotes(backupData.quotes || []);
                    setProjects(backupData.projects || []);
                    setExpenses(backupData.expenses || []);
                    setTimeEntries(backupData.timeEntries || []);
                    setCompanyProfiles(backupData.companyProfiles || []);
                    setSettings(backupData.settings || settings);
                    setReminders(backupData.reminders || []);
                    setCategories(backupData.categories || categories);
                    
                    alert('Backup erfolgreich importiert!');
                    setModals(prev => ({ ...prev, backup: false }));
                  }
                } catch (error) {
                  alert('Fehler beim Importieren des Backups!');
                }
              };
              reader.readAsText(file);
            }
          };
        
          // Theme management
          const toggleDarkMode = () => {
            setDarkMode(!darkMode);
            setSettings(prev => ({ ...prev, theme: !darkMode ? 'dark' : 'light' }));
          };
        
          // Filtering and searching
          const getFilteredItems = (items) => {
            return items.filter(item => {
              const matchesSearch = filters.search === '' || 
                Object.values(item).some(value => 
                  value && value.toString().toLowerCase().includes(filters.search.toLowerCase())
                );
              
              const matchesStatus = filters.status === 'all' || item.status === filters.status;
              
              return matchesSearch && matchesStatus;
            });
          };
        
          const theme = darkMode ? 'dark' : 'light';
          const bgClass = darkMode ? 'bg-gray-900' : 'bg-gray-50';
          const cardClass = darkMode ? 'bg-gray-800 text-white' : 'bg-white';
          const textClass = darkMode ? 'text-gray-100' : 'text-gray-900';
        
          return (
            <div className={`min-h-screen ${bgClass} transition-colors duration-300`}>
              {/* Enhanced Header */}
              <header className={`${cardClass} shadow-lg border-b transition-colors duration-300`}>
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="flex justify-between items-center py-4">
                    <div className="flex items-center gap-4">
                      {companyData.logo && (
                        <img src={companyData.logo} alt="Logo" className="h-12 w-12 object-contain rounded" />
                      )}
                      <div>
                        <h1 className={`text-2xl font-bold ${textClass}`}>Enterprise Invoice Pro 3.0</h1>
                        <p className="text-sm text-gray-500">Professionelle Rechnungsverwaltung</p>
                      </div>
                    </div>
                    
                    <div className="flex items-center gap-4">
                      {/* Language Switcher */}
                      <select
                        value={currentLanguage}
                        onChange={(e) => {
                          setCurrentLanguage(e.target.value);
                          setSettings(prev => ({ ...prev, language: e.target.value }));
                        }}
                        className={`px-3 py-1 rounded-md border ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                      >
                        <option value="de">🇩🇪 Deutsch</option>
                        <option value="en">🇺🇸 English</option>
                      </select>
                      
                      {/* Dark Mode Toggle */}
                      <button
                        onClick={toggleDarkMode}
                        className={`p-2 rounded-md ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-600'} hover:bg-opacity-80 transition-colors`}
                      >
                        {darkMode ? <Sun className="h-5 w-5" /> : <Moon className="h-5 w-5" />}
                      </button>
                      
                      {/* Quick Actions */}
                      <div className="flex gap-2">
                        <button
                          onClick={() => setModals(prev => ({ ...prev, invoice: true }))}
                          className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2 transition-colors"
                        >
                          <Plus className="h-4 w-4" />
                          Rechnung
                        </button>
                        <button
                          onClick={() => setModals(prev => ({ ...prev, settings: true }))}
                          className={`p-2 rounded-md ${darkMode ? 'bg-gray-700' : 'bg-gray-200'} hover:bg-opacity-80 transition-colors`}
                        >
                          <Settings className="h-5 w-5" />
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </header>
        
              {/* Enhanced Navigation */}
              <nav className={`${cardClass} shadow-sm transition-colors duration-300`}>
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="flex space-x-8 overflow-x-auto">
                    {[
                      { id: 'dashboard', name: t('dashboard'), icon: BarChart3 },
                      { id: 'customers', name: t('customers'), icon: Users },
                      { id: 'products', name: t('products'), icon: Package },
                      { id: 'invoices', name: t('invoices'), icon: FileText },
                      { id: 'quotes', name: t('quotes'), icon: Receipt },
                      { id: 'projects', name: t('projects'), icon: Briefcase },
                      { id: 'expenses', name: t('expenses'), icon: CreditCard },
                      { id: 'reports', name: t('reports'), icon: PieChart }
                    ].map(tab => {
                      const Icon = tab.icon;
                      return (
                        <button
                          key={tab.id}
                          onClick={() => setActiveTab(tab.id)}
                          className={`py-4 px-1 border-b-2 font-medium text-sm flex items-center gap-2 whitespace-nowrap transition-colors ${
                            activeTab === tab.id
                              ? 'border-blue-500 text-blue-600'
                              : `border-transparent ${darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`
                          }`}
                        >
                          <Icon className="h-4 w-4" />
                          {tab.name}
                        </button>
                      );
                    })}
                  </div>
                </div>
              </nav>
        
              {/* Main Content */}
              <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                {/* Enhanced Dashboard */}
                {activeTab === 'dashboard' && (
                  <div className="space-y-8">
                    {/* Stats Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                      <div className={`${cardClass} p-6 rounded-xl shadow-sm transition-colors duration-300`}>
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm font-medium text-gray-500">Jahresumsatz</p>
                            <p className={`text-2xl font-bold ${textClass}`}>{formatCurrency(stats.yearlyRevenue)}</p>
                            <p className="text-xs text-green-600 mt-1">+12% vs. Vorjahr</p>
                          </div>
                          <div className="p-3 bg-green-100 rounded-full">
                            <TrendingUp className="h-8 w-8 text-green-600" />
                          </div>
                        </div>
                      </div>
        
                      <div className={`${cardClass} p-6 rounded-xl shadow-sm transition-colors duration-300`}>
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm font-medium text-gray-500">Monatsumsatz</p>
                            <p className={`text-2xl font-bold ${textClass}`}>{formatCurrency(stats.monthlyRevenue)}</p>
                            <p className="text-xs text-blue-600 mt-1">Aktueller Monat</p>
                          </div>
                          <div className="p-3 bg-blue-100 rounded-full">
                            <DollarSign className="h-8 w-8 text-blue-600" />
                          </div>
                        </div>
                      </div>
        
                      <div className={`${cardClass} p-6 rounded-xl shadow-sm transition-colors duration-300`}>
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm font-medium text-gray-500">Offene Rechnungen</p>
                            <p className={`text-2xl font-bold ${textClass}`}>{stats.openInvoices}</p>
                            <p className="text-xs text-orange-600 mt-1">{formatCurrency(stats.totalOutstanding)}</p>
                          </div>
                          <div className="p-3 bg-orange-100 rounded-full">
                            <Clock className="h-8 w-8 text-orange-600" />
                          </div>
                        </div>
                      </div>
        
                      <div className={`${cardClass} p-6 rounded-xl shadow-sm transition-colors duration-300`}>
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm font-medium text-gray-500">Überfällige Rechnungen</p>
                            <p className={`text-2xl font-bold ${textClass} text-red-600`}>{stats.overdueInvoices}</p>
                            <p className="text-xs text-red-600 mt-1">{formatCurrency(stats.totalOverdue)}</p>
                          </div>
                          <div className="p-3 bg-red-100 rounded-full">
                            <AlertTriangle className="h-8 w-8 text-red-600" />
                          </div>
                        </div>
                      </div>
                    </div>
        
                    {/* Quick Overview */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Recent Invoices */}
                      <div className={`${cardClass} rounded-xl shadow-sm transition-colors duration-300`}>
                        <div className="p-6 border-b border-gray-200">
                          <h3 className={`text-lg font-semibold ${textClass}`}>Neueste Rechnungen</h3>
                        </div>
                        <div className="p-6">
                          <div className="space-y-4">
                            {invoices.slice(0, 5).map(invoice => (
                              <div key={invoice.id} className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                  <div className={`w-2 h-2 rounded-full ${
                                    invoice.status === 'paid' ? 'bg-green-500' :
                                    invoice.status === 'open' ? 'bg-yellow-500' : 'bg-red-500'
                                  }`} />
                                  <div>
                                    <p className={`font-medium ${textClass}`}>{invoice.number}</p>
                                    <p className="text-sm text-gray-500">{invoice.customer.name}</p>
                                  </div>
                                </div>
                                <div className="text-right">
                                  <p className={`font-semibold ${textClass}`}>{formatCurrency(invoice.total)}</p>
                                  <p className="text-xs text-gray-500">{formatDate(invoice.date)}</p>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
        
                      {/* Active Projects */}
                      <div className={`${cardClass} rounded-xl shadow-sm transition-colors duration-300`}>
                        <div className="p-6 border-b border-gray-200">
                          <h3 className={`text-lg font-semibold ${textClass}`}>Aktive Projekte</h3>
                        </div>
                        <div className="p-6">
                          <div className="space-y-4">
                            {projects.filter(p => p.status === 'active').slice(0, 5).map(project => (
                              <div key={project.id} className="flex items-center justify-between">
                                <div>
                                  <p className={`font-medium ${textClass}`}>{project.name}</p>
                                  <p className="text-sm text-gray-500">
                                    {customers.find(c => c.id === project.customerId)?.name}
                                  </p>
                                </div>
                                <div className="text-right">
                                  <p className={`font-semibold ${textClass}`}>{formatCurrency(project.budget)}</p>
                                  <p className="text-xs text-gray-500">{project.status}</p>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
        
                {/* Enhanced Customer Management */}
                {activeTab === 'customers' && (
                  <div className={`${cardClass} shadow-lg rounded-xl transition-colors duration-300`}>
                    <div className="px-6 py-4 border-b border-gray-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                      <h2 className={`text-xl font-semibold ${textClass}`}>Kundenverwaltung</h2>
                      <div className="flex gap-2">
                        <div className="relative">
                          <Search className="absolute left-3 top-3 h-4 w-4 text-gray-400" />
                          <input
                            type="text"
                            placeholder="Kunden suchen..."
                            value={filters.search}
                            onChange={(e) => setFilters(prev => ({ ...prev, search: e.target.value }))}
                            className={`pl-10 pr-4 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 ${
                              darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'
                            }`}
                          />
                        </div>
                        <button
                          onClick={() => exportToCSV(customers, 'kunden', ['name', 'email', 'address', 'phone'])}
                          className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center gap-2"
                        >
                          <Download className="h-4 w-4" />
                          Export
                        </button>
                        <button
                          onClick={() => setModals(prev => ({ ...prev, customer: true }))}
                          className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2"
                        >
                          <Plus className="h-4 w-4" />
                          Kunde hinzufügen
                        </button>
                      </div>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="min-w-full divide-y divide-gray-200">
                        <thead className={darkMode ? 'bg-gray-700' : 'bg-gray-50'}>
                          <tr>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Kunde</th>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Kontakt</th>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Adresse</th>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Zahlungsziel</th>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Aktionen</th>
                          </tr>
                        </thead>
                        <tbody className={`divide-y ${darkMode ? 'divide-gray-600' : 'divide-gray-200'}`}>
                          {getFilteredItems(customers).map(customer => (
                            <tr key={customer.id} className={darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'}>
                              <td className="px-6 py-4 whitespace-nowrap">
                                <div className="flex items-center">
                                  <div className="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold">
                                    {customer.name.charAt(0).toUpperCase()}
                                  </div>
                                  <div className="ml-4">
                                    <div className={`text-sm font-medium ${textClass}`}>{customer.name}</div>
                                    {customer.vatId && <div className="text-sm text-gray-500">USt-ID: {customer.vatId}</div>}
                                  </div>
                                </div>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                <div className="text-sm text-gray-500">
                                  <div>{customer.email}</div>
                                  <div>{customer.phone}</div>
                                  {customer.contactPerson && <div>Ansprechpartner: {customer.contactPerson}</div>}
                                </div>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {customer.address}<br />
                                {customer.postalCode} {customer.city}
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {customer.paymentTerms} Tage
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div className="flex gap-2">
                                  <button
                                    onClick={() => {
                                      setEditingItem(customer);
                                      setCustomerForm(customer);
                                      setModals(prev => ({ ...prev, customer: true }));
                                    }}
                                    className="text-indigo-600 hover:text-indigo-900"
                                  >
                                    <Edit className="h-4 w-4" />
                                  </button>
                                  <button
                                    onClick={() => deleteItem('customer', customer.id)}
                                    className="text-red-600 hover:text-red-900"
                                  >
                                    <Trash2 className="h-4 w-4" />
                                  </button>
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
        
                {/* Enhanced Product Management */}
                {activeTab === 'products' && (
                  <div className={`${cardClass} shadow-lg rounded-xl transition-colors duration-300`}>
                    <div className="px-6 py-4 border-b border-gray-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                      <h2 className={`text-xl font-semibold ${textClass}`}>Produktverwaltung</h2>
                      <div className="flex gap-2">
                        <div className="relative">
                          <Search className="absolute left-3 top-3 h-4 w-4 text-gray-400" />
                          <input
                            type="text"
                            placeholder="Produkte suchen..."
                            value={filters.search}
                            onChange={(e) => setFilters(prev => ({ ...prev, search: e.target.value }))}
                            className={`pl-10 pr-4 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 ${
                              darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'
                            }`}
                          />
                        </div>
                        <button
                          onClick={() => exportToCSV(products, 'produkte', ['name', 'description', 'price', 'taxRate'])}
                          className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center gap-2"
                        >
                          <Download className="h-4 w-4" />
                          Export
                        </button>
                        <button
                          onClick={() => setModals(prev => ({ ...prev, product: true }))}
                          className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2"
                        >
                          <Plus className="h-4 w-4" />
                          Produkt hinzufügen
                        </button>
                      </div>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="min-w-full divide-y divide-gray-200">
                        <thead className={darkMode ? 'bg-gray-700' : 'bg-gray-50'}>
                          <tr>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Produkt</th>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Kategorie</th>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Preis</th>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>MwSt</th>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Einheit</th>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Aktionen</th>
                          </tr>
                        </thead>
                        <tbody className={`divide-y ${darkMode ? 'divide-gray-600' : 'divide-gray-200'}`}>
                          {getFilteredItems(products).map(product => {
                            const category = categories.find(c => c.id === product.category);
                            return (
                              <tr key={product.id} className={darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'}>
                                <td className="px-6 py-4">
                                  <div>
                                    <div className={`text-sm font-medium ${textClass}`}>{product.name}</div>
                                    <div className="text-sm text-gray-500">{product.description}</div>
                                    {product.sku && <div className="text-xs text-gray-400">SKU: {product.sku}</div>}
                                  </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap">
                                  {category && (
                                    <span 
                                      className="px-2 py-1 text-xs font-medium rounded-full text-white"
                                      style={{ backgroundColor: category.color }}
                                    >
                                      {category.name}
                                    </span>
                                  )}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                  {formatCurrency(parseFloat(product.price))}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                  {product.taxRate}%
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                  {product.unit}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                  <div className="flex gap-2">
                                    <button
                                      onClick={() => {
                                        setEditingItem(product);
                                        setProductForm(product);
                                        setModals(prev => ({ ...prev, product: true }));
                                      }}
                                      className="text-indigo-600 hover:text-indigo-900"
                                    >
                                      <Edit className="h-4 w-4" />
                                    </button>
                                    <button
                                      onClick={() => deleteItem('product', product.id)}
                                      className="text-red-600 hover:text-red-900"
                                    >
                                      <Trash2 className="h-4 w-4" />
                                    </button>
                                  </div>
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
        
                {/* Enhanced Invoice Management */}
                {activeTab === 'invoices' && (
                  <div className={`${cardClass} shadow-lg rounded-xl transition-colors duration-300`}>
                    <div className="px-6 py-4 border-b border-gray-200">
                      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <h2 className={`text-xl font-semibold ${textClass}`}>Rechnungsverwaltung</h2>
                        <div className="flex gap-2 flex-wrap">
                          <button
                            onClick={() => exportToCSV(invoices, 'rechnungen', ['number', 'customer', 'date', 'total', 'status'])}
                            className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center gap-2"
                          >
                            <Download className="h-4 w-4" />
                            Export
                          </button>
                          <button
                            onClick={() => {
                              setInvoiceForm(prev => ({ ...prev, type: 'invoice' }));
                              setModals(prev => ({ ...prev, invoice: true }));
                            }}
                            className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2"
                          >
                            <Plus className="h-4 w-4" />
                            Rechnung erstellen
                          </button>
                        </div>
                      </div>
                      
                      <div className="flex flex-col sm:flex-row gap-4 mt-4">
                        <div className="relative flex-1">
                          <Search className="absolute left-3 top-3 h-4 w-4 text-gray-400" />
                          <input
                            type="text"
                            placeholder="Rechnungen suchen..."
                            value={filters.search}
                            onChange={(e) => setFilters(prev => ({ ...prev, search: e.target.value }))}
                            className={`pl-10 pr-4 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 w-full ${
                              darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'
                            }`}
                          />
                        </div>
                        <select
                          value={filters.status}
                          onChange={(e) => setFilters(prev => ({ ...prev, status: e.target.value }))}
                          className={`px-4 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 ${
                            darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'
                          }`}
                        >
                          <option value="all">Alle Status</option>
                          <option value="open">Offen</option>
                          <option value="paid">Bezahlt</option>
                          <option value="overdue">Überfällig</option>
                          <option value="cancelled">Storniert</option>
                        </select>
                      </div>
                    </div>
                    
                    <div className="overflow-x-auto">
                      <table className="min-w-full divide-y divide-gray-200">
                        <thead className={darkMode ? 'bg-gray-700' : 'bg-gray-50'}>
                          <tr>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Rechnung</th>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Kunde</th>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Datum</th>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Betrag</th>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Status</th>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Fällig in</th>
                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Aktionen</th>
                          </tr>
                        </thead>
                        <tbody className={`divide-y ${darkMode ? 'divide-gray-600' : 'divide-gray-200'}`}>
                          {getFilteredItems(invoices).map(invoice => {
                            const daysUntilDue = Math.ceil((new Date(invoice.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                            const isOverdue = daysUntilDue < 0 && invoice.status === 'open';
                            
                            return (
                              <tr key={invoice.id} className={`${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'} ${isOverdue ? 'bg-red-50' : ''}`}>
                                <td className="px-6 py-4 whitespace-nowrap">
                                  <div>
                                    <div className={`text-sm font-medium ${textClass}`}>{invoice.number}</div>
                                    <div className="text-sm text-gray-500">{formatDate(invoice.date)}</div>
                                  </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap">
                                  <div>
                                    <div className={`text-sm font-medium ${textClass}`}>{invoice.customer.name}</div>
                                    {invoice.project && <div className="text-sm text-gray-500">{invoice.project.name}</div>}
                                  </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                  {formatDate(invoice.date)}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap">
                                  <div>
                                    <div className={`text-sm font-medium ${textClass}`}>{formatCurrency(invoice.total)}</div>
                                    {invoice.discount > 0 && (
                                      <div className="text-xs text-green-600">
                                        -{formatCurrency(invoice.discount)} Rabatt
                                      </div>
                                    )}
                                  </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap">
                                  <span className={`px-2 py-1 text-xs font-medium rounded-full ${
                                    invoice.status === 'paid' ? 'bg-green-100 text-green-800' :
                                    invoice.status === 'open' && isOverdue ? 'bg-red-100 text-red-800' :
                                    invoice.status === 'open' ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-gray-100 text-gray-800'
                                  }`}>
                                    {invoice.status === 'paid' ? 'Bezahlt' :
                                     isOverdue ? 'Überfällig' :
                                     invoice.status === 'open' ? 'Offen' : 'Storniert'}
                                  </span>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                  {invoice.status === 'paid' ? 
                                    'Bezahlt' : 
                                    `${daysUntilDue} Tage`
                                  }
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                  <div className="flex gap-2">
                                    <button
                                      onClick={() => {
                                        setPreviewData(invoice);
                                        setModals(prev => ({ ...prev, preview: true }));
                                      }}
                                      className="text-blue-600 hover:text-blue-900"
                                      title="Vorschau"
                                    >
                                      <Eye className="h-4 w-4" />
                                    </button>
                                    <button
                                      onClick={() => generatePDF(invoice)}
                                      className="text-green-600 hover:text-green-900"
                                      title="PDF erstellen"
                                    >
                                      <Download className="h-4 w-4" />
                                    </button>
                                    {invoice.status === 'open' && (
                                      <button
                                        onClick={() => updateInvoiceStatus(invoice.id, 'paid')}
                                        className="text-green-600 hover:text-green-900"
                                        title="Als bezahlt markieren"
                                      >
                                        <CheckCircle className="h-4 w-4" />
                                      </button>
                                    )}
                                    <button
                                      onClick={() => deleteItem('invoice', invoice.id)}
                                      className="text-red-600 hover:text-red-900"
                                      title="Löschen"
                                    >
                                      <Trash2 className="h-4 w-4" />
                                    </button>
                                  </div>
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
        
                {/* Other tabs would continue here with the same pattern... */}
                {/* Due to space constraints, I'll include just the key modals */}
        
              </main>
        
              {/* Customer Modal */}
              {modals.customer && (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                  <div className="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                    <h3 className="text-lg font-bold mb-4">
                      {editingItem ? 'Kunde bearbeiten' : 'Neuen Kunden hinzufügen'}
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <input
                        type="text"
                        placeholder="Firmenname / Name *"
                        value={customerForm.name}
                        onChange={(e) => setCustomerForm({...customerForm, name: e.target.value})}
                        className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                        required
                      />
                      <input
                        type="text"
                        placeholder="Ansprechpartner"
                        value={customerForm.contactPerson}
                        onChange={(e) => setCustomerForm({...customerForm, contactPerson: e.target.value})}
                        className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                      />
                      <input
                        type="text"
                        placeholder="Straße und Hausnummer *"
                        value={customerForm.address}
                        onChange={(e) => setCustomerForm({...customerForm, address: e.target.value})}
                        className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                      />
                      <div className="flex gap-2">
                        <input
                          type="text"
                          placeholder="PLZ"
                          value={customerForm.postalCode}
                          onChange={(e) => setCustomerForm({...customerForm, postalCode: e.target.value})}
                          className="w-1/3 px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                        />
                        <input
                          type="text"
                          placeholder="Stadt"
                          value={customerForm.city}
                          onChange={(e) => setCustomerForm({...customerForm, city: e.target.value})}
                          className="w-2/3 px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                        />
                      </div>
                      <input
                        type="email"
                        placeholder="E-Mail-Adresse *"
                        value={customerForm.email}
                        onChange={(e) => setCustomerForm({...customerForm, email: e.target.value})}
                        className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                      />
                      <input
                        type="tel"
                        placeholder="Telefonnummer"
                        value={customerForm.phone}
                        onChange={(e) => setCustomerForm({...customerForm, phone: e.target.value})}
                        className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                      />
                      <input
                        type="url"
                        placeholder="Website (optional)"
                        value={customerForm.website}
                        onChange={(e) => setCustomerForm({...customerForm, website: e.target.value})}
                        className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                      />
                      <input
                        type="text"
                        placeholder="USt-ID (optional)"
                        value={customerForm.vatId}
                        onChange={(e) => setCustomerForm({...customerForm, vatId: e.target.value})}
                        className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                      />
                      <input
                        type="number"
                        placeholder="Zahlungsziel (Tage)"
                        value={customerForm.paymentTerms}
                        onChange={(e) => setCustomerForm({...customerForm, paymentTerms: e.target.value})}
                        className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    <div className="mt-4">
                      <textarea
                        placeholder="Notizen (optional)"
                        value={customerForm.notes}
                        onChange={(e) => setCustomerForm({...customerForm, notes: e.target.value})}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                        rows="3"
                      />
                    </div>
                    <div className="flex justify-end gap-2 mt-6">
                      <button
                        onClick={() => resetForms('customer')}
                        className="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50"
                      >
                        Abbrechen
                      </button>
                      <button
                        onClick={saveCustomer}
                        className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                      >
                        Speichern
                      </button>
                    </div>
                  </div>
                </div>
              )}
        
              {/* Settings Modal */}
              {modals.settings && (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                  <div className="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
                    <h3 className="text-lg font-bold mb-6">Einstellungen & Firmendaten</h3>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                      {/* Company Data */}
                      <div className="space-y-4">
                        <h4 className="font-semibold text-gray-800 border-b pb-2">Firmendaten</h4>
                        <div className="grid grid-cols-1 gap-4">
                          <input
                            type="text"
                            placeholder="Firmenname *"
                            value={companyData.name}
                            onChange={(e) => setCompanyData({...companyData, name: e.target.value})}
                            className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                          />
                          <input
                            type="text"
                            placeholder="Straße und Hausnummer *"
                            value={companyData.address}
                            onChange={(e) => setCompanyData({...companyData, address: e.target.value})}
                            className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                          />
                          <div className="grid grid-cols-2 gap-2">
                            <input
                              type="text"
                              placeholder="PLZ"
                              value={companyData.postalCode}
                              onChange={(e) => setCompanyData({...companyData, postalCode: e.target.value})}
                              className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            />
                            <input
                              type="text"
                              placeholder="Stadt"
                              value={companyData.city}
                              onChange={(e) => setCompanyData({...companyData, city: e.target.value})}
                              className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            />
                          </div>
                          <div className="grid grid-cols-2 gap-2">
                            <input
                              type="tel"
                              placeholder="Telefon"
                              value={companyData.phone}
                              onChange={(e) => setCompanyData({...companyData, phone: e.target.value})}
                              className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            />
                            <input
                              type="email"
                              placeholder="E-Mail *"
                              value={companyData.email}
                              onChange={(e) => setCompanyData({...companyData, email: e.target.value})}
                              className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            />
                          </div>
                          <input
                            type="url"
                            placeholder="Website"
                            value={companyData.website}
                            onChange={(e) => setCompanyData({...companyData, website: e.target.value})}
                            className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                          />
                          <div className="grid grid-cols-2 gap-2">
                            <input
                              type="text"
                              placeholder="Steuernummer"
                              value={companyData.taxId}
                              onChange={(e) => setCompanyData({...companyData, taxId: e.target.value})}
                              className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            />
                            <input
                              type="text"
                              placeholder="USt-ID"
                              value={companyData.vatId}
                              onChange={(e) => setCompanyData({...companyData, vatId: e.target.value})}
                              className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            />
                          </div>
                          <div className="grid grid-cols-3 gap-2">
                            <input
                              type="text"
                              placeholder="Bankname"
                              value={companyData.bankName}
                              onChange={(e) => setCompanyData({...companyData, bankName: e.target.value})}
                              className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            />
                            <input
                              type="text"
                              placeholder="IBAN"
                              value={companyData.iban}
                              onChange={(e) => setCompanyData({...companyData, iban: e.target.value})}
                              className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            />
                            <input
                              type="text"
                              placeholder="BIC"
                              value={companyData.bic}
                              onChange={(e) => setCompanyData({...companyData, bic: e.target.value})}
                              className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            />
                          </div>
                          
                          <div className="border-t pt-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Logo hochladen</label>
                            <input
                              ref={logoInputRef}
                              type="file"
                              accept="image/*"
                              onChange={handleLogoUpload}
                              className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                            />
                            {companyData.logo && (
                              <div className="mt-2">
                                <img src={companyData.logo} alt="Logo" className="h-16 w-16 object-contain border rounded" />
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
        
                      {/* App Settings */}
                      <div className="space-y-6">
                        <div className="space-y-4">
                          <h4 className="font-semibold text-gray-800 border-b pb-2">Anwendungseinstellungen</h4>
                          <div className="grid grid-cols-2 gap-2">
                            <select
                              value={settings.currency}
                              onChange={(e) => setSettings({...settings, currency: e.target.value})}
                              className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            >
                              <option value="EUR">€ Euro</option>
                              <option value="USD">$ US-Dollar</option>
                              <option value="GBP">£ Britisches Pfund</option>
                              <option value="CHF">Fr. Schweizer Franken</option>
                            </select>
                            <select
                              value={settings.taxRate}
                              onChange={(e) => setSettings({...settings, taxRate: parseFloat(e.target.value)})}
                              className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            >
                              <option value="19">19% MwSt (Standard)</option>
                              <option value="7">7% MwSt (Ermäßigt)</option>
                              <option value="0">0% MwSt (Kleinunternehmer)</option>
                            </select>
                          </div>
                          <div className="grid grid-cols-2 gap-2">
                            <input
                              type="text"
                              placeholder="Rechnungsprefix"
                              value={settings.invoicePrefix}
                              onChange={(e) => setSettings({...settings, invoicePrefix: e.target.value})}
                              className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            />
                            <input
                              type="text"
                              placeholder="Angebotsprefix"
                              value={settings.quotePrefix}
                              onChange={(e) => setSettings({...settings, quotePrefix: e.target.value})}
                              className="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            />
                          </div>
                          
                          <div className="flex items-center gap-2">
                            <input
                              type="checkbox"
                              id="smallBusiness"
                              checked={companyData.isSmallBusiness}
                              onChange={(e) => setCompanyData({...companyData, isSmallBusiness: e.target.checked})}
                              className="rounded"
                            />
                            <label htmlFor="smallBusiness" className="text-sm text-gray-700">
                              Kleinunternehmerregelung (§19 UStG)
                            </label>
                          </div>
                        </div>
        
                        {/* Backup & Import */}
                        <div className="space-y-4">
                          <h4 className="font-semibold text-gray-800 border-b pb-2">Datensicherung</h4>
                          <div className="grid grid-cols-2 gap-2">
                            <button
                              onClick={handleBackupExport}
                              className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center gap-2 justify-center"
                            >
                              <Download className="h-4 w-4" />
                              Backup erstellen
                            </button>
                            <button
                              onClick={() => fileInputRef.current?.click()}
                              className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2 justify-center"
                            >
                              <Upload className="h-4 w-4" />
                              Backup importieren
                            </button>
                          </div>
                          <input
                            ref={fileInputRef}
                            type="file"
                            accept=".json"
                            onChange={handleBackupImport}
                            className="hidden"
                          />
                          
                          <div className="text-xs text-gray-500 bg-gray-50 p-3 rounded">
                            <strong>Hinweis:</strong> Erstellen Sie regelmäßig Backups Ihrer Daten. 
                            Beim Import werden alle aktuellen Daten überschrieben.
                          </div>
                        </div>
        
                        {/* Statistics Overview */}
                        <div className="space-y-4">
                          <h4 className="font-semibold text-gray-800 border-b pb-2">Statistiken</h4>
                          <div className="grid grid-cols-2 gap-4 text-sm">
                            <div className="bg-blue-50 p-3 rounded">
                              <div className="text-blue-600 font-semibold">Kunden</div>
                              <div className="text-2xl font-bold text-blue-800">{customers.length}</div>
                            </div>
                            <div className="bg-green-50 p-3 rounded">
                              <div className="text-green-600 font-semibold">Produkte</div>
                              <div className="text-2xl font-bold text-green-800">{products.length}</div>
                            </div>
                            <div className="bg-purple-50 p-3 rounded">
                              <div className="text-purple-600 font-semibold">Rechnungen</div>
                              <div className="text-2xl font-bold text-purple-800">{invoices.length}</div>
                            </div>
                            <div className="bg-orange-50 p-3 rounded">
                              <div className="text-orange-600 font-semibold">Projekte</div>
                              <div className="text-2xl font-bold text-orange-800">{projects.length}</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div className="flex justify-end gap-2 mt-8 pt-4 border-t">
                      <button
                        onClick={() => setModals(prev => ({ ...prev, settings: false }))}
                        className="px-6 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50"
                      >
                        Schließen
                      </button>
                      <button
                        onClick={() => {
                          if (companyProfiles.length === 0 || !activeProfile) {
                            const newProfile = { ...companyData, id: Date.now().toString() };
                            setCompanyProfiles([newProfile]);
                            setActiveProfile(newProfile.id);
                          } else {
                            setCompanyProfiles(profiles => 
                              profiles.map(profile => 
                                profile.id === activeProfile ? companyData : profile
                              )
                            );
                          }
                          setModals(prev => ({ ...prev, settings: false }));
                        }}
                        className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                      >
                        Speichern
                      </button>
                    </div>
                  </div>
                </div>
              )}
        
            </div>
          );
        };
        
        ReactDOM.render(<EnterpriseInvoiceApp />, document.getElementById('root'));
    </script>
</body>
</html>
